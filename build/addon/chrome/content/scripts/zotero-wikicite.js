"use strict";(()=>{var At=Object.create;var rt=Object.defineProperty;var St=Object.getOwnPropertyDescriptor;var Nt=Object.getOwnPropertyNames;var Gt=Object.getPrototypeOf,Bt=Object.prototype.hasOwnProperty;var v=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var Ht=(r,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Nt(e))!Bt.call(r,s)&&s!==t&&rt(r,s,{get:()=>e[s],enumerable:!(i=St(e,s))||i.enumerable});return r};var D=(r,e,t)=>(t=r!=null?At(Gt(r)):{},Ht(e||!r||!r.__esModule?rt(t,"default",{value:r,enumerable:!0}):t,r));var st=v(F=>{"use strict";var Wt=F&&F.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(F,"__esModule",{value:!0});F.DebugBridge=void 0;var _e=y(),Mt=Wt(z()),O=class r{get version(){return r.version}get disableDebugBridgePassword(){return this._disableDebugBridgePassword}set disableDebugBridgePassword(e){this._disableDebugBridgePassword=e}get password(){return _e.BasicTool.getZotero().Prefs.get(r.passwordPref,!0)}set password(e){_e.BasicTool.getZotero().Prefs.set(r.passwordPref,e,!0)}constructor(){this._disableDebugBridgePassword=!1,this.initializeDebugBridge()}static setModule(e){var t;(!(!((t=e.debugBridge)===null||t===void 0)&&t.version)||e.debugBridge.version<r.version)&&(e.debugBridge=new r)}initializeDebugBridge(){let e={noContent:!0,doAction:async t=>{var i;let s=_e.BasicTool.getZotero(),o=s.getMainWindow(),a=t.spec.split("//").pop();if(!a)return;let n={};(i=a.split("?").pop())===null||i===void 0||i.split("&").forEach(c=>{n[c.split("=")[0]]=decodeURIComponent(c.split("=")[1])});let l=Mt.default.getInstance().debugBridge.disableDebugBridgePassword,d=!1;if(l?d=!0:typeof n.password>"u"&&typeof this.password>"u"?d=o.confirm(`External App ${n.app} wants to execute command without password.
Command:
${(n.run||n.file||"").slice(0,100)}
If you do not know what it is, please click Cancel to deny.`):d=this.password===n.password,d){if(n.run)try{let c=Object.getPrototypeOf(async function(){}).constructor;await new c("Zotero,window",n.run)(s,o)}catch(c){s.debug(c),o.console.log(c)}if(n.file)try{Services.scriptloader.loadSubScript(n.file,{Zotero:s,window:o})}catch(c){s.debug(c),o.console.log(c)}}},newChannel:function(t){this.doAction(t)}};Services.io.getProtocolHandler("zotero").wrappedJSObject._extensions["zotero://ztoolkit-debug"]=e}};F.DebugBridge=O;O.version=2;O.passwordPref="extensions.zotero.debug-bridge.password"});var nt=v(ee=>{"use strict";Object.defineProperty(ee,"__esModule",{value:!0});ee.PluginBridge=void 0;var jt=y(),Y=class r{get version(){return r.version}constructor(){this.initializePluginBridge()}static setModule(e){var t;(!(!((t=e.pluginBridge)===null||t===void 0)&&t.version)||e.pluginBridge.version<r.version)&&(e.pluginBridge=new r)}initializePluginBridge(){let{AddonManager:e}=ChromeUtils.import("resource://gre/modules/AddonManager.jsm"),t=jt.BasicTool.getZotero(),i={noContent:!0,doAction:async s=>{var o;try{let a=s.spec.split("//").pop();if(!a)return;let n={};if((o=a.split("?").pop())===null||o===void 0||o.split("&").forEach(l=>{n[l.split("=")[0]]=decodeURIComponent(l.split("=")[1])}),n.action==="install"&&n.url){if(n.minVersion&&Services.vc.compare(t.version,n.minVersion)<0||n.maxVersion&&Services.vc.compare(t.version,n.maxVersion)>0)throw new Error(`Plugin is not compatible with Zotero version ${t.version}.The plugin requires Zotero version between ${n.minVersion} and ${n.maxVersion}.`);let l=await e.getInstallForURL(n.url);if(l&&l.state===e.STATE_AVAILABLE)l.install(),ot("Plugin installed successfully.",!0);else throw new Error(`Plugin ${n.url} is not available.`)}}catch(a){t.logError(a),ot(a.message,!1)}},newChannel:function(s){this.doAction(s)}};Services.io.getProtocolHandler("zotero").wrappedJSObject._extensions["zotero://plugin"]=i}};ee.PluginBridge=Y;Y.version=1;function ot(r,e){let t=new Zotero.ProgressWindow({closeOnClick:!0});t.changeHeadline("Plugin Toolkit"),t.progress=new t.ItemProgress(e?"chrome://zotero/skin/tick.png":"chrome://zotero/skin/cross.png",r),t.progress.setProgress(100),t.show(),t.startCloseTimer(5e3)}});var z=v(J=>{"use strict";Object.defineProperty(J,"__esModule",{value:!0});J.ToolkitGlobal=void 0;var Te=y(),$t=st(),Et=nt(),te=class r{constructor(){at(this),this.currentWindow=Te.BasicTool.getZotero().getMainWindow()}static getInstance(){let e=Te.BasicTool.getZotero(),t=!1;"_toolkitGlobal"in e||(e._toolkitGlobal=new r,t=!0);let i=e._toolkitGlobal;return i.currentWindow!==e.getMainWindow()&&(Dt(i),t=!0),t&&at(i),i}};J.ToolkitGlobal=te;function at(r){A(r,"fieldHooks",{_ready:!1,getFieldHooks:{},setFieldHooks:{},isFieldOfBaseHooks:{}}),A(r,"itemTree",{_ready:!1,columns:[],renderCellHooks:{}}),A(r,"itemBox",{_ready:!1,fieldOptions:{}}),A(r,"shortcut",{_ready:!1,eventKeys:[]}),A(r,"prompt",{_ready:!1,instance:void 0}),A(r,"readerInstance",{_ready:!1,initializedHooks:{}}),$t.DebugBridge.setModule(r),Et.PluginBridge.setModule(r)}function A(r,e,t){var i,s;if(t){r[e]||(r[e]=t);for(let o in t)(i=(s=r[e])[o])!==null&&i!==void 0||(s[o]=t[o])}}function Dt(r){r.currentWindow=Te.BasicTool.getZotero().getMainWindow(),r.itemTree=void 0,r.itemBox=void 0,r.shortcut=void 0,r.prompt=void 0,r.readerInstance=void 0}J.default=te});var y=v(T=>{"use strict";var Ot=T&&T.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(T,"__esModule",{value:!0});T.makeHelperTool=T.unregister=T.ManagerTool=T.BasicTool=void 0;var Jt=Ot(z()),Q=class r{get basicOptions(){return this._basicOptions}constructor(e){this.patchSign="zotero-plugin-toolkit@2.0.0",this._basicOptions={log:{_type:"toolkitlog",disableConsole:!1,disableZLog:!1,prefix:""},debug:Jt.default.getInstance().debugBridge,api:{pluginID:"zotero-plugin-toolkit@windingwind.com"},listeners:{callbacks:{onMainWindowLoad:new Set,onMainWindowUnload:new Set,onPluginUnload:new Set},_mainWindow:void 0,_plugin:void 0}},this.updateOptions(e)}getGlobal(e){let t=typeof Zotero<"u"?Zotero:Components.classes["@zotero.org/Zotero;1"].getService(Components.interfaces.nsISupports).wrappedJSObject;try{let i=t.getMainWindow();switch(e){case"Zotero":case"zotero":return t;case"window":return i;case"windows":return t.getMainWindows();case"document":return i.document;case"ZoteroPane":case"ZoteroPane_Local":return t.getActiveZoteroPane();default:return i[e]}}catch(i){Zotero.logError(i)}}isZotero7(){return Zotero.platformMajorVersion>=102}isFX115(){return Zotero.platformMajorVersion>=115}getDOMParser(){if(this.isZotero7())return new(this.getGlobal("DOMParser"));try{return new(this.getGlobal("DOMParser"))}catch{return Components.classes["@mozilla.org/xmlextras/domparser;1"].createInstance(Components.interfaces.nsIDOMParser)}}isXULElement(e){return e.namespaceURI==="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"}createXULElement(e,t){return this.isZotero7()?e.createXULElement(t):e.createElementNS("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul",t)}log(...e){var t;if(e.length===0)return;let i=this.getGlobal("Zotero"),s=this.getGlobal("console"),o;((t=e[e.length-1])===null||t===void 0?void 0:t._type)==="toolkitlog"?o=e.pop():o=this._basicOptions.log;try{o.prefix&&e.splice(0,0,o.prefix),o.disableConsole||(s.groupCollapsed(...e),s.trace(),s.groupEnd()),o.disableZLog||i.debug(e.map(a=>{try{return typeof a=="object"?JSON.stringify(a):String(a)}catch{return i.debug(a),""}}).join(`
`))}catch(a){s.error(a),i.logError(a)}}patch(e,t,i,s){if(e[t][i])throw new Error(`${String(t)} re-patched`);this.log("patching",t,`by ${i}`),e[t]=s(e[t]),e[t][i]=!0}addListenerCallback(e,t){["onMainWindowLoad","onMainWindowUnload"].includes(e)&&this._ensureMainWindowListener(),e==="onPluginUnload"&&this._ensurePluginListener(),this._basicOptions.listeners.callbacks[e].add(t)}removeListenerCallback(e,t){this._basicOptions.listeners.callbacks[e].delete(t),this._ensureRemoveListener()}_ensureRemoveListener(){let{listeners:e}=this._basicOptions;e._mainWindow&&e.callbacks.onMainWindowLoad.size===0&&e.callbacks.onMainWindowUnload.size===0&&(Services.wm.removeListener(e._mainWindow),delete e._mainWindow),e._plugin&&e.callbacks.onPluginUnload.size===0&&(Zotero.Plugins.removeObserver(e._plugin),delete e._plugin)}_ensureMainWindowListener(){if(this._basicOptions.listeners._mainWindow)return;let e={onOpenWindow:t=>{let i=t.docShell.domWindow,s=async()=>{if(i.removeEventListener("load",s,!1),i.location.href==="chrome://zotero/content/zoteroPane.xhtml")for(let o of this._basicOptions.listeners.callbacks.onMainWindowLoad)try{o(i)}catch(a){this.log(a)}};i.addEventListener("load",()=>s(),!1)},onCloseWindow:async t=>{let i=t.docShell.domWindow;if(i.location.href==="chrome://zotero/content/zoteroPane.xhtml")for(let s of this._basicOptions.listeners.callbacks.onMainWindowUnload)try{s(i)}catch(o){this.log(o)}}};this._basicOptions.listeners._mainWindow=e,Services.wm.addListener(e)}_ensurePluginListener(){if(this._basicOptions.listeners._plugin)return;let e={shutdown:(...t)=>{for(let i of this._basicOptions.listeners.callbacks.onPluginUnload)try{i(...t)}catch(s){this.log(s)}}};this._basicOptions.listeners._plugin=e,Zotero.Plugins.addObserver(e)}updateOptions(e){return e?(e instanceof r?this._basicOptions=e._basicOptions:this._basicOptions=e,this):this}static getZotero(){return typeof Zotero<"u"?Zotero:Components.classes["@zotero.org/Zotero;1"].getService(Components.interfaces.nsISupports).wrappedJSObject}};T.BasicTool=Q;var ie=class extends Q{_ensureAutoUnregisterAll(){this.addListenerCallback("onPluginUnload",(e,t)=>{e.id===this.basicOptions.api.pluginID&&this.unregisterAll()})}};T.ManagerTool=ie;function Qt(r){Object.values(r).forEach(e=>{(e instanceof ie||typeof e?.unregisterAll=="function")&&e.unregisterAll()})}T.unregister=Qt;function Ut(r,e){return new Proxy(r,{construct(t,i){let s=new r(...i);return s instanceof Q&&s.updateOptions(e),s}})}T.makeHelperTool=Ut});var C=v(re=>{"use strict";Object.defineProperty(re,"__esModule",{value:!0});re.UITool=void 0;var Yt=y(),Ie=class extends Yt.BasicTool{get basicOptions(){return this._basicOptions}constructor(e){super(e),this.elementCache=[],this._basicOptions.ui||(this._basicOptions.ui={enableElementRecord:!0,enableElementJSONLog:!1,enableElementDOMLog:!0})}unregisterAll(){this.elementCache.forEach(e=>{var t;try{(t=e?.deref())===null||t===void 0||t.remove()}catch(i){this.log(i)}})}createElement(...e){var t,i,s;let o=e[0],a=e[1].toLowerCase(),n=e[2]||{};if(!a)return;typeof e[2]=="string"&&(n={namespace:e[2],enableElementRecord:e[3]}),(typeof n.enableElementJSONLog<"u"&&n.enableElementJSONLog||this.basicOptions.ui.enableElementJSONLog)&&this.log(n),n.properties=n.properties||n.directAttributes,n.children=n.children||n.subElementOptions;let l;if(a==="fragment")l=o.createDocumentFragment();else{let d=n.id&&(n.checkExistenceParent?n.checkExistenceParent:o).querySelector(`#${n.id}`);if(d&&n.ignoreIfExists)return d;if(d&&n.removeIfExists&&(d.remove(),d=void 0),n.customCheck&&!n.customCheck(o,n))return;if(!d||!n.skipIfExists){let c=n.namespace;if(!c){let f=ei.includes(a),u=ti.includes(a),g=ii.includes(a);Number(f)+Number(u)+Number(g)>1&&this.log(`[Warning] Creating element ${a} with no namespace specified. Found multiply namespace matches.`),f?c="html":u?c="xul":g?c="svg":c="html"}c==="xul"?d=this.createXULElement(o,a):d=o.createElementNS({html:"http://www.w3.org/1999/xhtml",svg:"http://www.w3.org/2000/svg"}[c],a),(typeof n.enableElementRecord<"u"?n.enableElementRecord:this.basicOptions.ui.enableElementRecord)&&this.elementCache.push(new WeakRef(d))}n.id&&(d.id=n.id),n.styles&&Object.keys(n.styles).length&&Object.keys(n.styles).forEach(c=>{let f=n.styles[c];typeof f<"u"&&(d.style[c]=f)}),n.properties&&Object.keys(n.properties).length&&Object.keys(n.properties).forEach(c=>{let f=n.properties[c];typeof f<"u"&&(d[c]=f)}),n.attributes&&Object.keys(n.attributes).length&&Object.keys(n.attributes).forEach(c=>{let f=n.attributes[c];typeof f<"u"&&d.setAttribute(c,String(f))}),!((t=n.classList)===null||t===void 0)&&t.length&&d.classList.add(...n.classList),!((i=n.listeners)===null||i===void 0)&&i.length&&n.listeners.forEach(({type:c,listener:f,options:u})=>{f&&d.addEventListener(c,f,u)}),l=d}if(!((s=n.children)===null||s===void 0)&&s.length){let d=n.children.map(c=>(c.namespace=c.namespace||n.namespace,this.createElement(o,c.tag,c))).filter(c=>c);l.append(...d)}return(typeof n.enableElementDOMLog<"u"?n.enableElementDOMLog:this.basicOptions.ui.enableElementDOMLog)&&this.log(l),l}appendElement(e,t){return t.appendChild(this.createElement(t.ownerDocument,e.tag,e))}insertElementBefore(e,t){if(t.parentNode)return t.parentNode.insertBefore(this.createElement(t.ownerDocument,e.tag,e),t);this.log(t.tagName+" has no parent, cannot insert "+e.tag)}replaceElement(e,t){if(t.parentNode)return t.parentNode.replaceChild(this.createElement(t.ownerDocument,e.tag,e),t);this.log(t.tagName+" has no parent, cannot replace it with "+e.tag)}parseXHTMLToFragment(e,t=[],i=!0){let s=this.getDOMParser(),o="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul",a="http://www.w3.org/1999/xhtml",n=`${t.length?`<!DOCTYPE bindings [ ${t.reduce((c,f,u)=>c+`<!ENTITY % _dtd-${u} SYSTEM "${f}"> %_dtd-${u}; `,"")}]>`:""}
      <html:div xmlns="${i?o:a}"
          xmlns:xul="${o}" xmlns:html="${a}">
      ${e}
      </html:div>`;this.log(n,s);let l=s.parseFromString(n,"text/xml");if(this.log(l),l.documentElement.localName==="parsererror")throw new Error("not well-formed XHTML");let d=l.createRange();return d.selectNodeContents(l.querySelector("div")),d.extractContents()}};re.UITool=Ie;var ei=["a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","blockquote","body","br","button","canvas","caption","cite","code","col","colgroup","data","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","img","input","ins","kbd","label","legend","li","link","main","map","mark","menu","meta","meter","nav","noscript","object","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","script","section","select","slot","small","source","span","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr"],ti=["action","arrowscrollbox","bbox","binding","bindings","box","broadcaster","broadcasterset","button","browser","checkbox","caption","colorpicker","column","columns","commandset","command","conditions","content","deck","description","dialog","dialogheader","editor","grid","grippy","groupbox","hbox","iframe","image","key","keyset","label","listbox","listcell","listcol","listcols","listhead","listheader","listitem","member","menu","menubar","menuitem","menulist","menupopup","menuseparator","observes","overlay","page","popup","popupset","preference","preferences","prefpane","prefwindow","progressmeter","radio","radiogroup","resizer","richlistbox","richlistitem","row","rows","rule","script","scrollbar","scrollbox","scrollcorner","separator","spacer","splitter","stack","statusbar","statusbarpanel","stringbundle","stringbundleset","tab","tabbrowser","tabbox","tabpanel","tabpanels","tabs","template","textnode","textbox","titlebar","toolbar","toolbarbutton","toolbargrippy","toolbaritem","toolbarpalette","toolbarseparator","toolbarset","toolbarspacer","toolbarspring","toolbox","tooltip","tree","treecell","treechildren","treecol","treecols","treeitem","treerow","treeseparator","triple","vbox","window","wizard","wizardpage"],ii=["a","animate","animateMotion","animateTransform","circle","clipPath","defs","desc","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","foreignObject","g","image","line","linearGradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialGradient","rect","script","set","stop","style","svg","switch","symbol","text","textPath","title","tspan","use","view"]});var Ce=v(N=>{"use strict";Object.defineProperty(N,"__esModule",{value:!0});N.waitUtilAsync=N.waitUntil=void 0;var ri=y(),S=new ri.BasicTool;function si(r,e,t=100,i=1e4){let s=Date.now(),o=S.getGlobal("setInterval")(()=>{r()?(S.getGlobal("clearInterval")(o),e()):Date.now()-s>i&&S.getGlobal("clearInterval")(o)},t)}N.waitUntil=si;function oi(r,e=100,t=1e4){return new Promise((i,s)=>{let o=Date.now(),a=S.getGlobal("setInterval")(()=>{r()?(S.getGlobal("clearInterval")(a),i()):Date.now()-o>t&&(S.getGlobal("clearInterval")(a),s())},e)})}N.waitUtilAsync=oi});var ze=v(se=>{"use strict";Object.defineProperty(se,"__esModule",{value:!0});se.ReaderTool=void 0;var ni=y(),ai=Ce(),Pe=class extends ni.BasicTool{async getReader(e=5e3){let t=this.getGlobal("Zotero_Tabs");if(t.selectedType!=="reader")return;let i=Zotero.Reader.getByTabID(t.selectedID),s=0,o=50;for(;!i&&s*o<e;)await Zotero.Promise.delay(o),i=Zotero.Reader.getByTabID(t.selectedID),s++;return await i?._initPromise,i}getWindowReader(){let e=this.getGlobal("Zotero_Tabs"),t=[],i=e._tabs.map(s=>s.id);for(let s=0;s<Zotero.Reader._readers.length;s++){let o=!1;for(let a=0;a<i.length;a++)if(Zotero.Reader._readers[s].tabID==i[a]){o=!0;break}o||t.push(Zotero.Reader._readers[s])}return t}getReaderTabPanelDeck(){var e;return(e=this.getGlobal("window").document.querySelector(".notes-pane-deck"))===null||e===void 0?void 0:e.previousElementSibling}async addReaderTabPanelDeckObserver(e){await(0,ai.waitUtilAsync)(()=>!!this.getReaderTabPanelDeck());let t=this.getReaderTabPanelDeck(),i=new(this.getGlobal("MutationObserver"))(async s=>{s.forEach(async o=>{let a=o.target;(a.classList.contains("zotero-view-tabbox")||a.tagName==="deck")&&e()})});return i.observe(t,{attributes:!0,attributeFilter:["selectedIndex"],subtree:!0}),i}getSelectedAnnotationData(e){var t;return(t=e?._internalReader._lastView._selectionPopup)===null||t===void 0?void 0:t.annotation}getSelectedText(e){var t,i;return(i=(t=this.getSelectedAnnotationData(e))===null||t===void 0?void 0:t.text)!==null&&i!==void 0?i:""}};se.ReaderTool=Pe});var ct=v(oe=>{"use strict";Object.defineProperty(oe,"__esModule",{value:!0});oe.ExtraFieldTool=void 0;var li=y(),Le=class extends li.BasicTool{getExtraFields(e,t="custom"){let i=e.getField("extra");if(t==="default")return this.getGlobal("Zotero").Utilities.Internal.extractExtraFields(i).fields;{let s=new Map,o=[];return i.split(`
`).forEach(a=>{let n=a.split(": ");n.length>=2&&n[0]?s.set(n[0],n.slice(1).join(": ")):o.push(a)}),s.set("__nonStandard__",o.join(`
`)),s}}getExtraField(e,t){return this.getExtraFields(e).get(t)}async replaceExtraFields(e,t){let i=[];t.has("__nonStandard__")&&(i.push(t.get("__nonStandard__")),t.delete("__nonStandard__")),t.forEach((s,o)=>{i.push(`${o}: ${s}`)}),e.setField("extra",i.join(`
`)),await e.saveTx()}async setExtraField(e,t,i){let s=this.getExtraFields(e);i===""||typeof i>"u"?s.delete(t):s.set(t,i),await this.replaceExtraFields(e,s)}};oe.ExtraFieldTool=Le});var qe=v(ne=>{"use strict";Object.defineProperty(ne,"__esModule",{value:!0});ne.PatchHelper=void 0;var ci=y(),Ze=class extends ci.BasicTool{constructor(){super(),this.options=void 0}setData(e){this.options=e;let t=this.getGlobal("Zotero"),{target:i,funcSign:s,patcher:o}=e,a=i[s];return this.log("patching ",s),i[s]=function(...n){if(e.enabled)try{return o(a).apply(this,n)}catch(l){t.logError(l)}return a.apply(this,n)},this}enable(){if(!this.options)throw new Error("No patch data set");return this.options.enabled=!0,this}disable(){if(!this.options)throw new Error("No patch data set");return this.options.enabled=!1,this}};ne.PatchHelper=Ze});var le=v(ae=>{"use strict";Object.defineProperty(ae,"__esModule",{value:!0});ae.FieldHookManager=void 0;var Ve=qe(),di=y(),Re=class extends di.ManagerTool{constructor(e){super(e),this.data={getField:{},setField:{},isFieldOfBase:{}},this.patchHelpers={getField:new Ve.PatchHelper,setField:new Ve.PatchHelper,isFieldOfBase:new Ve.PatchHelper};let t=this;for(let i of Object.keys(this.patchHelpers))this.patchHelpers[i].setData({target:this.getGlobal("Zotero").Item.prototype,funcSign:i,patcher:o=>function(a,...n){let l=this,d=t.data[i][a];if(typeof d=="function")try{return d(a,n[0],n[1],l,o)}catch(c){return a+String(c)}return o.apply(l,[a,...n])},enabled:!0})}register(e,t,i){this.data[e][t]=i}unregister(e,t){delete this.data[e][t]}unregisterAll(){this.data.getField={},this.data.setField={},this.data.isFieldOfBase={},this.patchHelpers.getField.disable(),this.patchHelpers.setField.disable(),this.patchHelpers.isFieldOfBase.disable()}};ae.FieldHookManager=Re});var Fe=v(ce=>{"use strict";Object.defineProperty(ce,"__esModule",{value:!0});ce.PatcherManager=void 0;var ui=y(),Ke=class extends ui.ManagerTool{constructor(e){super(e),this.patcherIDMap=new Map}register(e,t,i){let s=this.getGlobal("Zotero"),o=this.patcherIDMap,a=s.randomString();for(;o.has(a);)a=s.randomString();let n=e[t];return o.set(a,!0),this.log("patching ",t),e[t]=function(...l){if(o.get(a))try{return i(n).apply(this,l)}catch(d){s.logError(d)}return n.apply(this,l)},a}unregister(e){this.patcherIDMap.delete(e)}unregisterAll(){this.patcherIDMap.clear()}};ce.PatcherManager=Ke});var dt=v(G=>{"use strict";var hi=G&&G.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(G,"__esModule",{value:!0});G.ItemTreeManager=void 0;var fi=y(),pi=le(),gi=hi(z()),mi=Fe(),Ae=class extends fi.ManagerTool{constructor(e){super(e),this.defaultPersist=["width","ordinal","hidden","sortActive","sortDirection"],this.backend=this.getGlobal("Zotero").ItemTreeManager,this.localColumnCache=[],this.localRenderCellCache=[],this.fieldHooks=new pi.FieldHookManager(e),this.patcherManager=new mi.PatcherManager(e),this.initializationLock=this.getGlobal("Zotero").Promise.defer(),this.backend?this.initializationLock.resolve():this.initializeGlobal()}unregisterAll(){[...this.localColumnCache].forEach(e=>this.unregister(e,{skipGetField:!0})),[...this.localRenderCellCache].forEach(this.removeRenderCellHook.bind(this)),this.fieldHooks.unregisterAll()}async register(e,t,i,s={showInColumnPicker:!0}){var o;if(await((o=this.initializationLock)===null||o===void 0?void 0:o.promise),!this.backend&&this.globalCache.columns.map(n=>n.dataKey).includes(e)){this.log(`ItemTreeTool: ${e} is already registered.`);return}let a={dataKey:e,label:t,pluginID:this._basicOptions.api.pluginID,iconLabel:s.iconPath?this.createIconLabel({iconPath:s.iconPath,name:t}):void 0,iconPath:s.iconPath,htmlLabel:s.htmlLabel,zoteroPersist:s.zoteroPersist||(this.backend?this.defaultPersist:new Set(this.defaultPersist)),defaultIn:s.defaultIn,disabledIn:s.disabledIn,enabledTreeIDs:s.enabledTreeIDs,defaultSort:s.defaultSort,sortReverse:s.sortReverse||s.defaultSort===-1,flex:typeof s.flex>"u"?1:s.flex,width:s.width,fixedWidth:s.fixedWidth,staticWidth:s.staticWidth,minWidth:s.minWidth,ignoreInColumnPicker:s.ignoreInColumnPicker,showInColumnPicker:typeof s.ignoreInColumnPicker>"u"?!0:s.showInColumnPicker,submenu:s.submenu,columnPickerSubMenu:s.columnPickerSubMenu||s.submenu,dataProvider:s.dataProvider||((n,l)=>n.getField(e)),renderCell:s.renderCell||s.renderCellHook};if(i&&this.fieldHooks.register("getField",e,i),this.backend)return await this.backend.registerColumns(a);this.globalCache.columns.push(a),this.localColumnCache.push(a.dataKey),s.renderCellHook&&await this.addRenderCellHook(e,s.renderCellHook),await this.refresh()}async unregister(e,t={}){if(await this.initializationLock.promise,this.backend){await this.backend.unregisterColumns(e),t.skipGetField||this.fieldHooks.unregister("getField",e);return}let i=this.getGlobal("Zotero"),s=i.Prefs.get("pane.persist"),o=JSON.parse(s);delete o[e],i.Prefs.set("pane.persist",JSON.stringify(o));let a=this.globalCache.columns.map(l=>l.dataKey).indexOf(e);a>=0&&this.globalCache.columns.splice(a,1),t.skipGetField||this.fieldHooks.unregister("getField",e),this.removeRenderCellHook(e),await this.refresh();let n=this.localColumnCache.indexOf(e);n>=0&&this.localColumnCache.splice(n,1)}async addRenderCellHook(e,t){await this.initializationLock.promise,e in this.globalCache.renderCellHooks&&this.log("[WARNING] ItemTreeTool.addRenderCellHook overwrites an existing hook:",e),this.globalCache.renderCellHooks[e]=t,this.localRenderCellCache.push(e)}async removeRenderCellHook(e){delete this.globalCache.renderCellHooks[e];let t=this.localRenderCellCache.indexOf(e);t>=0&&this.localRenderCellCache.splice(t,1),await this.refresh()}async initializeGlobal(){await this.getGlobal("Zotero").uiReadyPromise;let t=this.getGlobal("window");this.globalCache=gi.default.getInstance().itemTree;let i=this.globalCache;if(!i._ready){i._ready=!0;let s=t.require("zotero/itemTree");this.backend||this.patcherManager.register(s.prototype,"getColumns",o=>function(){let a=o.apply(this,arguments),n=a.findIndex(l=>l.dataKey==="title");return a.splice(n+1,0,...i.columns),a}),this.patcherManager.register(s.prototype,"_renderCell",o=>function(a,n,l){if(!(l.dataKey in i.renderCellHooks))return o.apply(this,arguments);let d=i.renderCellHooks[l.dataKey],c=d(a,n,l,o.bind(this));if(c.classList.contains("cell"))return c;let f=t.document.createElementNS("http://www.w3.org/1999/xhtml","span");return f.classList.add("cell",l.dataKey,`${l.dataKey}-item-tree-main-default`),l.fixedWidth&&f.classList.add("fixed-width"),f.appendChild(c),f})}this.initializationLock.resolve()}createIconLabel(e){let t=window.require("react");return t.createElement("span",null,t.createElement("img",{src:e.iconPath,height:"10px",width:"9px",style:{"margin-left":"6px"}})," ",e.name)}async refresh(){var e,t;await this.initializationLock.promise;let s=this.getGlobal("ZoteroPane").itemsView;if(!s)return;s._columnsId=null;let o=(e=s.tree)===null||e===void 0?void 0:e._columns;if(!o){this.log("ItemTree is still loading. Refresh skipped.");return}(t=document.querySelector(`.${o._styleKey}`))===null||t===void 0||t.remove(),await s.refreshAndMaintainSelection(),s.tree._columns=new o.__proto__.constructor(s.tree),await s.refreshAndMaintainSelection()}};G.ItemTreeManager=Ae});var ut=v(L=>{"use strict";var bi=L&&L.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(L,"__esModule",{value:!0});L.PromptManager=L.Prompt=void 0;var yi=y(),vi=y(),wi=C(),ki=bi(z()),de=class{get document(){return this.base.getGlobal("document")}constructor(){this.lastInputText="",this.defaultText={placeholder:"Select a command...",empty:"No commands found."},this.maxLineNum=12,this.maxSuggestionNum=100,this.commands=[],this.base=new yi.BasicTool,this.ui=new wi.UITool,this.initializeUI()}initializeUI(){this.addStyle(),this.createHTML(),this.initInputEvents(),this.registerShortcut()}createHTML(){this.promptNode=this.ui.createElement(this.document,"div",{styles:{display:"none"},children:[{tag:"div",styles:{position:"fixed",left:"0",top:"0",backgroundColor:"transparent",width:"100%",height:"100%"},listeners:[{type:"click",listener:()=>{this.promptNode.style.display="none"}}]}]}),this.promptNode.appendChild(this.ui.createElement(this.document,"div",{id:"zotero-plugin-toolkit-prompt",classList:["prompt-container"],children:[{tag:"div",classList:["input-container"],children:[{tag:"input",classList:["prompt-input"],attributes:{type:"text",placeholder:this.defaultText.placeholder}},{tag:"div",classList:["cta"]}]},{tag:"div",classList:["commands-containers"]},{tag:"div",classList:["instructions"],children:[{tag:"div",classList:["instruction"],children:[{tag:"span",classList:["key"],properties:{innerText:"\u2191\u2193"}},{tag:"span",properties:{innerText:"to navigate"}}]},{tag:"div",classList:["instruction"],children:[{tag:"span",classList:["key"],properties:{innerText:"enter"}},{tag:"span",properties:{innerText:"to trigger"}}]},{tag:"div",classList:["instruction"],children:[{tag:"span",classList:["key"],properties:{innerText:"esc"}},{tag:"span",properties:{innerText:"to exit"}}]}]}]})),this.inputNode=this.promptNode.querySelector("input"),this.document.documentElement.appendChild(this.promptNode)}showCommands(e,t=!1){t&&this.promptNode.querySelectorAll(".commands-container").forEach(s=>s.remove()),this.inputNode.placeholder=this.defaultText.placeholder;let i=this.createCommandsContainer();for(let s of e){try{if(!s.name||s.when&&!s.when())continue}catch{continue}i.appendChild(this.createCommandNode(s))}}createCommandsContainer(){let e=this.ui.createElement(this.document,"div",{classList:["commands-container"]});return this.promptNode.querySelectorAll(".commands-container").forEach(t=>{t.style.display="none"}),this.promptNode.querySelector(".commands-containers").appendChild(e),e}getCommandsContainer(){return[...Array.from(this.promptNode.querySelectorAll(".commands-container"))].find(e=>e.style.display!="none")}createCommandNode(e){let t=this.ui.createElement(this.document,"div",{classList:["command"],children:[{tag:"div",classList:["content"],children:[{tag:"div",classList:["name"],children:[{tag:"span",properties:{innerText:e.name}}]},{tag:"div",classList:["aux"],children:e.label?[{tag:"span",classList:["label"],properties:{innerText:e.label}}]:[]}]}],listeners:[{type:"mousemove",listener:()=>{this.selectItem(t)}},{type:"click",listener:async()=>{await this.execCallback(e.callback)}}]});return t.command=e,t}trigger(){[...Array.from(this.promptNode.querySelectorAll(".commands-container"))].find(e=>e.style.display!="none").querySelector(".selected").click()}exit(){if(this.inputNode.placeholder=this.defaultText.placeholder,this.promptNode.querySelectorAll(".commands-containers .commands-container").length>=2){this.promptNode.querySelector(".commands-container:last-child").remove();let e=this.promptNode.querySelector(".commands-container:last-child");e.style.display="",e.querySelectorAll(".commands").forEach(t=>t.style.display="flex"),this.inputNode.focus()}else this.promptNode.style.display="none"}async execCallback(e){Array.isArray(e)?this.showCommands(e):await e(this)}async showSuggestions(e){var t=/[\u2000-\u206F\u2E00-\u2E7F\\'!"#$%&()*+,\-.\/:;<=>?@\[\]^_`{|}~]/,i=/\s/,s=/[\u0F00-\u0FFF\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/;function o(u,g,h,m){if(u.length===0)return 0;var p=0;p-=Math.max(0,u.length-1),p-=m/10;var b=u[0][0];return p-=(u[u.length-1][1]-b+1-g)/100,p-=b/1e3,p-=h/1e4}function a(u,g,h,m){if(u.length===0)return null;for(var p=h.toLowerCase(),b=0,w=0,k=[],q=0;q<u.length;q++){var R=u[q],_=p.indexOf(R,w);if(_===-1)return null;var K=h.charAt(_);if(_>0&&!t.test(K)&&!s.test(K)){var E=h.charAt(_-1);if(K.toLowerCase()!==K&&E.toLowerCase()!==E||K.toUpperCase()!==K&&!t.test(E)&&!i.test(E)&&!s.test(E))if(m){if(_!==w){w+=R.length,q--;continue}}else b+=1}if(k.length===0)k.push([_,_+R.length]);else{var it=k[k.length-1];it[1]<_?k.push([_,_+R.length]):it[1]=_+R.length}w=_+R.length}return{matches:k,score:o(k,g.length,p.length,b)}}function n(u){for(var g=u.toLowerCase(),h=[],m=0,p=0;p<g.length;p++){var b=g.charAt(p);i.test(b)?(m!==p&&h.push(g.substring(m,p)),m=p+1):(t.test(b)||s.test(b))&&(m!==p&&h.push(g.substring(m,p)),h.push(b),m=p+1)}return m!==g.length&&h.push(g.substring(m,g.length)),{query:u,tokens:h,fuzzy:g.split("")}}function l(u,g){if(u.query==="")return{score:0,matches:[]};var h=a(u.tokens,u.query,g,!1);return h||a(u.fuzzy,u.query,g,!0)}var d=n(e);let c=this.getCommandsContainer();if(c.classList.contains("suggestions")&&this.exit(),e.trim()=="")return!0;let f=[];if(this.getCommandsContainer().querySelectorAll(".command").forEach(u=>{let h=u.querySelector(".name span").innerText,m=l(d,h);if(m){u=this.createCommandNode(u.command);let p="",b=0;for(let w=0;w<m.matches.length;w++){let[k,q]=m.matches[w];k>b&&(p+=h.slice(b,k)),p+=`<span class="highlight">${h.slice(k,q)}</span>`,b=q}b<h.length&&(p+=h.slice(b,h.length)),u.querySelector(".name span").innerHTML=p,f.push({score:m.score,commandNode:u})}}),f.length>0)return f.sort((u,g)=>g.score-u.score).slice(this.maxSuggestionNum),c=this.createCommandsContainer(),c.classList.add("suggestions"),f.forEach(u=>{c.appendChild(u.commandNode)}),!0;{let u=this.commands.find(g=>!g.name&&(!g.when||g.when()));return u?await this.execCallback(u.callback):this.showTip(this.defaultText.empty),!1}}initInputEvents(){this.promptNode.addEventListener("keydown",e=>{if(["ArrowUp","ArrowDown"].indexOf(e.key)!=-1){e.preventDefault();let t,i=[...Array.from(this.getCommandsContainer().querySelectorAll(".command"))].filter(o=>o.style.display!="none");t=i.findIndex(o=>o.classList.contains("selected")),t!=-1?(i[t].classList.remove("selected"),t+=e.key=="ArrowUp"?-1:1):e.key=="ArrowUp"?t=i.length-1:t=0,t==-1?t=i.length-1:t==i.length&&(t=0),i[t].classList.add("selected");let s=this.getCommandsContainer();s.scrollTo(0,s.querySelector(".selected").offsetTop-s.offsetHeight+7.5),i[t].classList.add("selected")}}),this.promptNode.addEventListener("keyup",async e=>{if(e.key=="Enter")this.trigger();else if(e.key=="Escape")this.inputNode.value.length>0?this.inputNode.value="":this.exit();else if(["ArrowUp","ArrowDown"].indexOf(e.key)!=-1)return;let t=this.inputNode.value;t!=this.lastInputText&&(this.lastInputText=t,window.setTimeout(async()=>{await this.showSuggestions(t)}))})}showTip(e){let t=this.ui.createElement(this.document,"div",{classList:["tip"],properties:{innerText:e}}),i=this.createCommandsContainer();return i.classList.add("suggestions"),i.appendChild(t),t}selectItem(e){this.getCommandsContainer().querySelectorAll(".command").forEach(t=>t.classList.remove("selected")),e.classList.add("selected")}addStyle(){let e=this.ui.createElement(this.document,"style",{namespace:"html",id:"prompt-style"});e.innerText=`
      .prompt-container * {
        box-sizing: border-box;
      }
      .prompt-container {
        ---radius---: 10px;
        position: fixed;
        left: 25%;
        top: 10%;
        width: 50%;
        border-radius: var(---radius---);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        box-shadow: 0px 1.8px 7.3px rgba(0, 0, 0, 0.071),
                    0px 6.3px 24.7px rgba(0, 0, 0, 0.112),
                    0px 30px 90px rgba(0, 0, 0, 0.2);
        font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Microsoft YaHei Light", sans-serif;
        background-color: var(--material-background) !important;
        border: var(--material-border-quarternary) !important;
      }
      
      /* input */
      .prompt-container .input-container  {
        width: 100%;
      }

      .input-container input {
        width: -moz-available;
        height: 40px;
        padding: 24px;
        border: none;
        outline: none;
        font-size: 18px;
        margin: 0 !important;
        border-radius: var(---radius---);
        background-color: var(--material-background);
      }
      
      .input-container .cta {
        border-bottom: var(--material-border-quarternary);
        margin: 5px auto;
      }
      
      /* results */
      .commands-containers {
        width: 100%;
        height: 100%;
      }
      .commands-container {
        max-height: calc(${this.maxLineNum} * 35.5px);
        width: calc(100% - 12px);
        margin-left: 12px;
        margin-right: 0%;
        overflow-y: auto;
        overflow-x: hidden;
      }
      
      .commands-container .command {
        display: flex;
        align-content: baseline;
        justify-content: space-between;
        border-radius: 5px;
        padding: 6px 12px;
        margin-right: 12px;
        margin-top: 2px;
        margin-bottom: 2px;
      }
      .commands-container .command .content {
        display: flex;
        width: 100%;
        justify-content: space-between;
        flex-direction: row;
        overflow: hidden;
      }
      .commands-container .command .content .name {
        white-space: nowrap; 
        text-overflow: ellipsis;
        overflow: hidden;
      }
      .commands-container .command .content .aux {
        display: flex;
        align-items: center;
        align-self: center;
        flex-shrink: 0;
      }
      
      .commands-container .command .content .aux .label {
        font-size: 15px;
        color: var(--fill-primary);
        padding: 2px 6px;
        background-color: var(--color-background);
        border-radius: 5px;
      }
      
      .commands-container .selected {
          background-color: var(--material-mix-quinary);
      }

      .commands-container .highlight {
        font-weight: bold;
      }

      .tip {
        color: var(--fill-primary);
        text-align: center;
        padding: 12px 12px;
        font-size: 18px;
      }

      /* instructions */
      .instructions {
        display: flex;
        align-content: center;
        justify-content: center;
        font-size: 15px;
        height: 2.5em;
        width: 100%;
        border-top: var(--material-border-quarternary);
        color: var(--fill-secondary);
        margin-top: 5px;
      }
      
      .instructions .instruction {
        margin: auto .5em;  
      }
      
      .instructions .key {
        margin-right: .2em;
        font-weight: 600;
      }
`});var _t=v(W=>{"use strict";var $i=W&&W.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(W,"__esModule",{value:!0});W.ReaderInstanceManager=void 0;var Ei=y(),Di=$i(z()),Ue=class extends Ei.ManagerTool{constructor(e){super(e),this.cachedHookIds=[],this.initializeGlobal()}register(e,t,i){let s=this.getGlobal("Zotero");switch(e){case"initialized":this.globalCache.initializedHooks[t]=i,s.Reader._readers.forEach(i);break;default:break}this.cachedHookIds.push(t)}unregister(e){delete this.globalCache.initializedHooks[e]}unregisterAll(){this.cachedHookIds.forEach(e=>this.unregister(e))}initializeGlobal(){if(this.globalCache=Di.default.getInstance().readerInstance,!this.globalCache._ready){this.globalCache._ready=!0;let e=this.getGlobal("Zotero"),t=this;e.Reader._readers=new(this.getGlobal("Proxy"))(e.Reader._readers,{set(i,s,o,a){return i[s]=o,isNaN(Number(s))||Object.values(t.globalCache.initializedHooks).forEach(n=>{try{n(o)}catch(l){t.log(l)}}),!0}})}}};W.ReaderInstanceManager=Ue});var Tt=v(M=>{"use strict";var Oi=M&&M.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(M,"__esModule",{value:!0});M.ItemBoxManager=void 0;var Ji=y(),Qi=le(),Ui=Fe(),Xi=Oi(z()),Xe=class extends Ji.ManagerTool{constructor(e){super(e),this.initializationLock=this.getGlobal("Zotero").Promise.defer(),this.localCache=[],this.fieldHooks=new Qi.FieldHookManager,this.patcherManager=new Ui.PatcherManager,this.initializeGlobal()}async register(e,t,i,s={}){this.fieldHooks.register("isFieldOfBase",e,()=>!1),i&&this.fieldHooks.register("getField",e,i),s.editable&&s.setFieldHook&&this.fieldHooks.register("setField",e,s.setFieldHook),this.globalCache.fieldOptions[e]={field:e,displayName:t,editable:s.editable||!1,index:s.index||-1,multiline:s.multiline||!1,collapsible:s.collapsible||!1},this.localCache.push(e),await this.initializationLock.promise,this.refresh()}unregister(e,t={}){delete this.globalCache.fieldOptions[e],t.skipIsFieldOfBase||this.fieldHooks.unregister("isFieldOfBase",e),t.skipGetField||this.fieldHooks.unregister("getField",e),t.skipSetField||this.fieldHooks.unregister("setField",e);let i=this.localCache.indexOf(e);i>-1&&this.localCache.splice(i,1),t.skipRefresh||this.refresh()}unregisterAll(){[...this.localCache].forEach(e=>this.unregister(e,{skipGetField:!0,skipSetField:!0,skipIsFieldOfBase:!0,skipRefresh:!0})),this.fieldHooks.unregisterAll(),this.refresh()}refresh(){try{Array.from(this.getGlobal("document").querySelectorAll(this.isZotero7()?"item-box":"zoteroitembox")).forEach(e=>e.refresh())}catch(e){this.log(e)}}async initializeGlobal(){let e=this.getGlobal("Zotero");await e.uiReadyPromise;let t=this.getGlobal("window");this.globalCache=Xi.default.getInstance().itemBox;let i=this.globalCache,s=this.isZotero7();if(!i._ready){i._ready=!0;let o;if(s)o=new(this.getGlobal("customElements").get("item-box"));else{o=t.document.querySelector("#zotero-editpane-item-box");let a=5e3,n=0;for(;!o&&n<a;)o=t.document.querySelector("#zotero-editpane-item-box"),await e.Promise.delay(10),n+=10;if(!o){i._ready=!1,this.log("ItemBox initialization failed");return}}this.patcherManager.register(o.__proto__,"refresh",a=>function(){let n=this;a.apply(n,arguments);for(let l of Object.values(i.fieldOptions)){let d=document.createElement(s?"th":"label");d.setAttribute("fieldname",l.field);let c=`extensions.zotero.pluginToolkit.fieldCollapsed.${l.field}`,f=l.multiline&&l.collapsible&&e.Prefs.get(c,!0),u=l.displayName;if(f&&(u=`(...)${u}`),s){let b=document.createElement("label");b.className="key",b.textContent=u,d.appendChild(b)}else d.setAttribute("value",u);let g=n.clickable;n.clickable=l.editable;let h=n.createValueElement(n.item.getField(l.field),l.field,1099);n.clickable=g,l.multiline&&!e.Prefs.get(c,!0)?h.classList.add("multiline"):s||(h.setAttribute("crop","end"),h.setAttribute("value",h.innerHTML),h.innerHTML=""),l.collapsible&&d.addEventListener("click",function(b){e.Prefs.set(c,!e.Prefs.get(c,!0),!0),n.refresh()}),d.addEventListener("click",s?function(b){var w;let k=(w=b.currentTarget.nextElementSibling)===null||w===void 0?void 0:w.querySelector("input, textarea");k&&k.blur()}:function(b){var w;let k=(w=b.currentTarget.nextElementSibling)===null||w===void 0?void 0:w.inputField;k&&k.blur()});let m=s?n._infoTable:n._dynamicFields,p=l.index;p===0&&(p=1),p&&p>=0&&p<m.children.length?(n._beforeRow=m.children[p],n.addDynamicRow(d,h,!0)):n.addDynamicRow(d,h)}})}this.initializationLock.resolve()}};M.ItemBoxManager=Xe});var Ct=v(we=>{"use strict";Object.defineProperty(we,"__esModule",{value:!0});we.LargePrefHelper=void 0;var Yi=y(),Ye=class extends Yi.BasicTool{constructor(e,t,i="default"){super(),this.keyPref=e,this.valuePrefPrefix=t,i==="default"?this.hooks=It:i==="parser"?this.hooks=er:this.hooks=Object.assign(Object.assign({},It),i),this.innerObj={}}asObject(){return this.constructTempObj()}asMapLike(){let e={get:t=>this.getValue(t),set:(t,i)=>(this.setValue(t,i),e),has:t=>this.hasKey(t),delete:t=>this.deleteKey(t),clear:()=>{for(let t of this.getKeys())this.deleteKey(t)},forEach:t=>this.constructTempMap().forEach(t),get size(){return this._this.getKeys().length},entries:()=>this.constructTempMap().values(),keys:()=>this.getKeys()[Symbol.iterator](),values:()=>this.constructTempMap().values(),[Symbol.iterator]:()=>this.constructTempMap()[Symbol.iterator](),[Symbol.toStringTag]:"MapLike",_this:this};return e}getKeys(){let e=Zotero.Prefs.get(this.keyPref,!0),t=e?JSON.parse(e):[];for(let i of t){let s="placeholder";this.innerObj[i]=s}return t}setKeys(e){e=[...new Set(e.filter(t=>t))],Zotero.Prefs.set(this.keyPref,JSON.stringify(e),!0);for(let t of e){let i="placeholder";this.innerObj[t]=i}}getValue(e){let t=Zotero.Prefs.get(`${this.valuePrefPrefix}${e}`,!0);if(typeof t>"u")return;let{value:i}=this.hooks.afterGetValue({value:t});return this.innerObj[e]=i,i}setValue(e,t){let{key:i,value:s}=this.hooks.beforeSetValue({key:e,value:t});this.setKey(i),Zotero.Prefs.set(`${this.valuePrefPrefix}${i}`,s,!0),this.innerObj[i]=s}hasKey(e){return this.getKeys().includes(e)}setKey(e){let t=this.getKeys();t.includes(e)||(t.push(e),this.setKeys(t))}deleteKey(e){let t=this.getKeys(),i=t.indexOf(e);return i>-1&&(t.splice(i,1),delete this.innerObj[e],this.setKeys(t)),Zotero.Prefs.clear(`${this.valuePrefPrefix}${e}`,!0),!0}constructTempObj(){return new Proxy(this.innerObj,{get:(e,t,i)=>(this.getKeys(),typeof t=="string"&&t in e&&this.getValue(t),Reflect.get(e,t,i)),set:(e,t,i,s)=>typeof t=="string"?i===void 0?(this.deleteKey(t),!0):(this.setValue(t,i),!0):Reflect.set(e,t,i,s),has:(e,t)=>(this.getKeys(),Reflect.has(e,t)),deleteProperty:(e,t)=>typeof t=="string"?(this.deleteKey(t),!0):Reflect.deleteProperty(e,t)})}constructTempMap(){let e=new Map;for(let t of this.getKeys())e.set(t,this.getValue(t));return e}};we.LargePrefHelper=Ye;var It={afterGetValue:({value:r})=>({value:r}),beforeSetValue:({key:r,value:e})=>({key:r,value:e})},er={afterGetValue:({value:r})=>{try{r=JSON.parse(r)}catch{return{value:r}}return{value:r}},beforeSetValue:({key:r,value:e})=>(e=JSON.stringify(e),{key:r,value:e})}});var Pt=v($=>{"use strict";Object.defineProperty($,"__esModule",{value:!0});$.KeyModifier=$.KeyboardManager=void 0;var tr=y(),ir=Ce(),et=class extends tr.ManagerTool{constructor(e){super(e),this._keyboardCallbacks=new Set,this.initKeyboardListener=this._initKeyboardListener.bind(this),this.unInitKeyboardListener=this._unInitKeyboardListener.bind(this),this.triggerKeydown=t=>{this._cachedKey?this._cachedKey.merge(new j(t),{allowOverwrite:!1}):this._cachedKey=new j(t),this.dispatchCallback(t,{type:"keydown"})},this.triggerKeyup=async t=>{if(!this._cachedKey)return;let i=new j(this._cachedKey);this._cachedKey=void 0,this.dispatchCallback(t,{keyboard:i,type:"keyup"})},this.id=Zotero.Utilities.randomString(),this._ensureAutoUnregisterAll(),this.addListenerCallback("onMainWindowLoad",this.initKeyboardListener),this.addListenerCallback("onMainWindowUnload",this.unInitKeyboardListener),this.initReaderKeyboardListener();for(let t of Zotero.getMainWindows())this.initKeyboardListener(t)}register(e){this._keyboardCallbacks.add(e)}unregister(e){this._keyboardCallbacks.delete(e)}unregisterAll(){this._keyboardCallbacks.clear(),this.removeListenerCallback("onMainWindowLoad",this.initKeyboardListener),this.removeListenerCallback("onMainWindowUnload",this.unInitKeyboardListener);for(let e of Zotero.getMainWindows())this.unInitKeyboardListener(e)}initReaderKeyboardListener(){Zotero.Reader.registerEventListener("renderToolbar",e=>this.addReaderKeyboardCallback(e),this._basicOptions.api.pluginID),Zotero.Reader._readers.forEach(e=>this.addReaderKeyboardCallback({reader:e}))}addReaderKeyboardCallback(e){let t=e.reader,i=`_ztoolkitKeyboard${this.id}Initialized`;t._iframeWindow[i]||(this._initKeyboardListener(t._iframeWindow),(0,ir.waitUntil)(()=>{var s,o;return!Components.utils.isDeadWrapper(t._internalReader)&&((o=(s=t._internalReader)===null||s===void 0?void 0:s._primaryView)===null||o===void 0?void 0:o._iframeWindow)},()=>{var s;return this._initKeyboardListener((s=t._internalReader._primaryView)===null||s===void 0?void 0:s._iframeWindow)}),t._iframeWindow[i]=!0)}_initKeyboardListener(e){e&&(e.addEventListener("keydown",this.triggerKeydown),e.addEventListener("keyup",this.triggerKeyup))}_unInitKeyboardListener(e){e&&(e.removeEventListener("keydown",this.triggerKeydown),e.removeEventListener("keyup",this.triggerKeyup))}dispatchCallback(...e){this._keyboardCallbacks.forEach(t=>t(...e))}};$.KeyboardManager=et;var j=class r{constructor(e,t){this.accel=!1,this.shift=!1,this.control=!1,this.meta=!1,this.alt=!1,this.key="",this.useAccel=!1,this.useAccel=t?.useAccel||!1,!(typeof e>"u")&&(typeof e=="string"?(e=e||"",e=this.unLocalized(e),this.accel=e.includes("accel"),this.shift=e.includes("shift"),this.control=e.includes("control"),this.meta=e.includes("meta"),this.alt=e.includes("alt"),this.key=e.replace(/(accel|shift|control|meta|alt| |,|-)/g,"").toLocaleLowerCase()):e instanceof r?this.merge(e,{allowOverwrite:!0}):(t?.useAccel&&(Zotero.isMac?this.accel=e.metaKey:this.accel=e.ctrlKey),this.shift=e.shiftKey,this.control=e.ctrlKey,this.meta=e.metaKey,this.alt=e.altKey,["Shift","Meta","Ctrl","Alt","Control"].includes(e.key)||(this.key=e.key)))}merge(e,t){let i=t?.allowOverwrite||!1;return this.mergeAttribute("accel",e.accel,i),this.mergeAttribute("shift",e.shift,i),this.mergeAttribute("control",e.control,i),this.mergeAttribute("meta",e.meta,i),this.mergeAttribute("alt",e.alt,i),this.mergeAttribute("key",e.key,i),this}equals(e){if(typeof e=="string"&&(e=new r(e)),this.shift!==e.shift||this.alt!==e.alt||this.key.toLowerCase()!==e.key.toLowerCase())return!1;if(this.accel||e.accel){if(Zotero.isMac){if((this.accel||this.meta)!==(e.accel||e.meta)||this.control!==e.control)return!1}else if((this.accel||this.control)!==(e.accel||e.control)||this.meta!==e.meta)return!1}else if(this.control!==e.control||this.meta!==e.meta)return!1;return!0}getRaw(){let e=[];return this.accel&&e.push("accel"),this.shift&&e.push("shift"),this.control&&e.push("control"),this.meta&&e.push("meta"),this.alt&&e.push("alt"),this.key&&e.push(this.key),e.join(",")}getLocalized(){let e=this.getRaw();return Zotero.isMac?e.replaceAll("control","\u2303").replaceAll("alt","\u2325").replaceAll("shift","\u21E7").replaceAll("meta","\u2318"):e.replaceAll("control","Ctrl").replaceAll("alt","Alt").replaceAll("shift","Shift").replaceAll("meta","Win")}unLocalized(e){return Zotero.isMac?e.replaceAll("\u2303","control").replaceAll("\u2325","alt").replaceAll("\u21E7","shift").replaceAll("\u2318","meta"):e.replaceAll("Ctrl","control").replaceAll("Alt","alt").replaceAll("Shift","shift").replaceAll("Win","meta")}mergeAttribute(e,t,i){(i||!this[e])&&(this[e]=t)}};$.KeyModifier=j});var zt=v(U=>{"use strict";Object.defineProperty(U,"__esModule",{value:!0});U.ZoteroToolkit=void 0;var P=y(),rr=C(),sr=ze(),or=ct(),nr=dt(),ar=ut(),lr=ht(),cr=ft(),dr=pt(),ur=Me(),hr=mt(),fr=bt(),pr=yt(),gr=vt(),mr=wt(),br=xt(),yr=_t(),vr=le(),wr=Tt(),kr=Ct(),xr=Pt(),_r=qe(),ke=class extends P.BasicTool{constructor(){super(),this.UI=new rr.UITool(this),this.Reader=new sr.ReaderTool(this),this.ExtraField=new or.ExtraFieldTool(this),this.FieldHooks=new vr.FieldHookManager(this),this.ItemTree=new nr.ItemTreeManager(this),this.ItemBox=new wr.ItemBoxManager(this),this.Keyboard=new xr.KeyboardManager(this),this.Prompt=new ar.PromptManager(this),this.LibraryTabPanel=new lr.LibraryTabPanelManager(this),this.ReaderTabPanel=new cr.ReaderTabPanelManager(this),this.ReaderInstance=new yr.ReaderInstanceManager(this),this.Menu=new dr.MenuManager(this),this.PreferencePane=new ur.PreferencePaneManager(this),this.Shortcut=new hr.ShortcutManager(this),this.Clipboard=(0,P.makeHelperTool)(fr.ClipboardHelper,this),this.FilePicker=(0,P.makeHelperTool)(pr.FilePickerHelper,this),this.Patch=(0,P.makeHelperTool)(_r.PatchHelper,this),this.ProgressWindow=(0,P.makeHelperTool)(gr.ProgressWindowHelper,this),this.VirtualizedTable=(0,P.makeHelperTool)(mr.VirtualizedTableHelper,this),this.Dialog=(0,P.makeHelperTool)(br.DialogHelper,this),this.LargePrefObject=(0,P.makeHelperTool)(kr.LargePrefHelper,this)}unregisterAll(){(0,P.unregister)(this)}};U.ZoteroToolkit=ke;U.default=ke});var Kt=D(y());var I={addonName:"Zotero Cita",addonID:"zotero-wikicite@wikidata.org",addonRef:"zotero-wikicite",addonInstance:"ZoteroCita",prefsPrefix:"extensions.cita",releasePage:"https://github.com/diegodlh/zotero-cita/releases",updateJSON:"https://github.com/diegodlh/zotero-cita/releases/latest/download/update.json"};function lt(){let r=new(typeof Localization>"u"?ztoolkit.getGlobal("Localization"):Localization)([`${I.addonRef}-addon.ftl`],!0);addon.data.locale={current:r}}var Lt=D(zt());var Zt=D(y()),Ir=D(C()),Cr=D(Me());function xe(){let r=new Lt.default;return Tr(r),r}function Tr(r){let e="production";r.basicOptions.log.prefix=`[${I.addonName}]`,r.basicOptions.log.disableConsole=e==="production",r.UI.basicOptions.ui.enableElementJSONLog=!1,r.UI.basicOptions.ui.enableElementDOMLog=!1,r.basicOptions.debug.disableDebugBridgePassword=!1,r.basicOptions.api.pluginID=I.addonID,r.ProgressWindow.setIconURI("default",`chrome://${I.addonRef}/content/icons/favicon.png`)}async function Pr(){await Promise.all([Zotero.initializationPromise,Zotero.unlockPromise,Zotero.uiReadyPromise]),lt(),await qt(window)}async function qt(r){addon.data.ztoolkit=xe()}async function zr(r){ztoolkit.unregisterAll(),addon.data.dialog?.window?.close()}function Lr(){ztoolkit.unregisterAll(),addon.data.dialog?.window?.close(),addon.data.alive=!1,delete Zotero[I.addonInstance]}var Vt={onStartup:Pr,onShutdown:Lr,onMainWindowLoad:qt,onMainWindowUnload:zr};var tt=class{constructor(){this.data={alive:!0,env:"production",ztoolkit:xe()},this.hooks=Vt,this.api={}}},Rt=tt;var Ft=new Kt.BasicTool;Ft.getGlobal("Zotero")[I.addonInstance]||(X("window"),X("document"),X("ZoteroPane"),X("Zotero_Tabs"),_globalThis.addon=new Rt,X("ztoolkit",()=>_globalThis.addon.data.ztoolkit),Zotero[I.addonInstance]=addon,ztoolkit);function X(r,e){Object.defineProperty(_globalThis,r,{get(){return e?e():Ft.getGlobal(r)}})}})();
